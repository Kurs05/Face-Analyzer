{% extends 'app/base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<div class="main-container">
    <div class="top-section">
        <div class="upload-container">
            <div class="upload-area" id="upload-area">
              <p id="drag_a_drop">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞<br>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
              <input type="file" id="file-input" accept="image/*,video/*" hidden>

              <div class="preview" id="preview">
                <button class="remove-preview" id='remove_btn' onclick="event.stopPropagation(); removePreview();resetFileInput()">√ó</button>
                <img id="img-preview" src="#" alt="" style="display:none;">
                <video id="video-preview" controls style="display:none;"></video>
                <div class="filename" id="filename"></div>
              </div>
            </div>

            <button class="analyze-btn" id="analyze-btn">
              üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Ü–æ
            </button>
        </div>

        <div class="card features-card">
            <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h3>
            <ul class="features-list">
                <li><strong>–ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π</strong><br>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å—á–∞—Å—Ç—å—è, –≥—Ä—É—Å—Ç–∏, —É–¥–∏–≤–ª–µ–Ω–∏—è –∏ –¥—Ä.</li>
                <li><strong>–ü–æ–ª –∏ –≤–æ–∑—Ä–∞—Å—Ç</strong><br>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–∞ –∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞</li>
                <li><strong>–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—ã</strong><br>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—ã —Ç–∞–∫–æ–π –∫–∞–∫ indian, white, black –∏ –¥—Ä.<br></li>
                <li><strong>–ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –ª–∏—Ü–∞</strong><br>–î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ —á–µ—Ä—Ç –ª–∏—Ü–∞</li>
            </ul>
        </div>
    </div>

    <div class="card result-card">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ª–∏—Ü–∞</h3>
        <div class="result-container" id="results" style="display: none;">
          <div class="result-header">
            <div class="face-count" id="faces-count">0</div>
            <div>–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ª–∏—Ü</div>
          </div>

         <div class="data-container">
              <div class="btn-group-2">
                <button class="tab-btn active" onclick="showSection('media', this)">
                  <i class="fas fa-photo-film"></i> –ú–µ–¥–∏–∞
                </button>
                <button class="tab-btn" onclick="showSection('facedata', this)">
                  <i class="fas fa-user"></i> –î–∞–Ω–Ω—ã–µ –ª–∏—Ü–∞
                </button>
                <button class="tab-btn" onclick="showSection('landmarks', this)">
                  <i class="fas fa-map-marked-alt"></i> –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏
                </button>
              </div>

              <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: Media -->
              <div id="section-media" class="section-block">
                <div class="images">
                  <div class="image-block">
                    <div class="image-title">–û—Ä–∏–≥–∏–Ω–∞–ª</div>
                    <img id="original-img" src="" alt="–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                  </div>
                  <div class="image-block">
                    <div class="image-title">–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    <img id="processed-img" src="" alt="–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                  </div>
                </div>
              </div>
              <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: FaceData -->
                <div id="section-facedata" class="section-block" style="display: none;">
                  <table class="face-table">
                    <thead>
                      <tr>
                        <th>ID –ª–∏—Ü–∞</th>
                        <th>–ü–æ–ª</th>
                        <th>–í–æ–∑—Ä–∞—Å—Ç</th>
                        <th>–ì–ª–∞–≤–Ω–∞—è —ç–º–æ—Ü–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>

              <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: Landmarks -->
              <div id="section-landmarks" class="section-block" style="display: none;">
                 <div class="image-block">
                    <div class="image-title">–ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏</div>
                    <img id="landmark-img" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç–æ—á–∫–∞–º–∏">
                  </div>
              </div>
                    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
                <div id="face-modal" class="modal" style="display:none;">
                  <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <div id="modal-details"></div>
                  </div>
                </div>

            </div>
        </div>
    </div>
</div>
<script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview');
    const imgPreview = document.getElementById('img-preview');
    const videoPreview = document.getElementById('video-preview');
    const filenameText = document.getElementById('filename');
    const analyzeBtn = document.getElementById('analyze-btn');
    const drgDrp = document.getElementById('drag_a_drop');
    const removeBtn = document.getElementById('remove_btn');

    // click to open file dialog
    uploadArea.addEventListener('click', () => fileInput.click());

    // handle dropped file
    uploadArea.addEventListener('dragover', e => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      handleFile(file);
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      handleFile(file);
    });
  function handleFile(file) {
      if (!file) return;

      const allowedTypes = ['image/', 'video/'];
      const isAllowed = allowedTypes.some(type => file.type.startsWith(type));

    if (!isAllowed) {
        alert("–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ—Ñ–∞–π–ª—ã!");
        resetFileInput();  // –û—á–∏—Å—Ç–∏–º input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª
        return;
    }
      // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–µ–≤—å—é
      removePreview();
      drgDrp.style.display = 'none';
      const url = URL.createObjectURL(file);
      filenameText.textContent = `${file.name} (${(file.size / (1024 * 1024)).toFixed(1)} MB)`;

      if (file.type.startsWith('image')) {
        imgPreview.src = url;
        imgPreview.style.display = 'block';
      } else if (file.type.startsWith('video')) {
        videoPreview.src = url;
        videoPreview.style.display = 'block';
      }

      preview.style.display = 'flex';
      analyzeBtn.style.display = 'inline-block';


  }
   analyzeBtn.addEventListener('click', async () => {
        analyzeBtn.textContent = '‚è≥ –§–∞–π–ª –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ...';
        analyzeBtn.disabled = true;

        const file = fileInput.files[0];
        if (!file) {
            alert("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);
        try {
            removeBtn.style.visibility='hidden';
            const response = await fetch("{% url 'analize_file' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken()
            },
            body: formData
        });

            const data = await response.json();

            if (!response.ok) {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
                removePreview();
                 removeBtn.style.visibility='visible';
            } else {
                alert('–£—Å–ø–µ—Ö: ' + data.message);
                 setTimeout(() => {
                removePreview();
                removeBtn.style.visibility='visible';

                analyzeBtn.textContent = '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!';
            }, 2000);
                document.getElementById('processed-img').src = data.end_file_path;
                document.getElementById('original-img').src = data.start_file_path;
                document.getElementById('faces-count').innerText = data.count_faces;
                document.getElementById('results').style.display = 'block';
                document.getElementById('landmark-img').src = data.file_landmarks;
                show_table_data(data);
            }
        }
       catch (error) {
        console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', error);

        // –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è
        if (error instanceof SyntaxError) {
            console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ JSON:', error.message);
        } else if (error instanceof TypeError) {
            console.error('–¢–∏–ø–æ–≤–∞—è –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, fetch –Ω–µ —É–¥–∞–ª—Å—è):', error.message);
        } else {
            console.error('–û–±—â–∞—è –æ—à–∏–±–∫–∞:', error.message);
        }


        if (error.response) {
            console.error('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', error.response.status, error.response.statusText);
            console.error('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', error.response.data);
        }

    removePreview();
    removeBtn.style.visibility = 'visible';
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. –≤ –∫–æ–Ω—Å–æ–ª–∏.');
}

  });

    function getCSRFToken() {
        return document.cookie
            .split(";")
            .find(cookie => cookie.trim().startsWith("csrftoken="))
            ?.split("=")[1];
    }
    function removePreview() {
      imgPreview.src = '#';
      imgPreview.style.display = 'none';

      videoPreview.src = '';
      videoPreview.load(); // –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
      videoPreview.style.display = 'none';

      filenameText.textContent = '';
      preview.style.display = 'none';
      analyzeBtn.style.display = 'none';
      analyzeBtn.textContent = 'üìä –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª';
      analyzeBtn.disabled = false;
      drgDrp.style.display = 'block';


    }
    function resetFileInput() {
        fileInput.value = '';
    }
    function showSection(sectionId, btn) {
      // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
      document.querySelectorAll('.section-block').forEach(section => {
        section.style.display = 'none';
      });

      // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é
      const target = document.getElementById(`section-${sectionId}`);
      if (target) target.style.display = 'block';

      // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    function show_table_data(data) {
    const faceDataContainer = document.getElementById('section-facedata');
    faceDataContainer.innerHTML = '';

    const table = document.createElement('table');
    table.className = 'face-table';

    table.innerHTML = `
      <thead>
        <tr>
          <th>ID –ª–∏—Ü–∞</th>
          <th>–ü–æ–ª</th>
          <th>–í–æ–∑—Ä–∞—Å—Ç</th>
          <th>–ü—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∞—è —ç–º–æ—Ü–∏—è</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        ${data.face_data.map((face, index) => `
          <tr data-index="${index}">
            <td>${face.Id}</td>
            <td>${face.dominant_gender}</td>
            <td>${face.age}</td>
            <td><strong>${face.dominant_emotion}</strong> ${face.emotion[face.dominant_emotion]}%</td>
            <td><button class="details-btn">üîç –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></td>
          </tr>
        `).join('')}
      </tbody>
    `;
    faceDataContainer.appendChild(table);

    const buttons = table.querySelectorAll('.details-btn');
    buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = e.target.closest('tr').dataset.index;
            const face = data.face_data[index];
            showModalDetails(face);
        });
    });
}

function showModalDetails(face) {
    const modal = document.getElementById('face-modal');
    const details = document.getElementById('modal-details');

    const emotionsHTML = Object.entries(face.emotion).map(([emotion, value]) => `
        <div><strong>${emotion}</strong>: ${value}%</div>
    `).join('');

    const raceHTML = face.race ? `
        <h4>–†–∞—Å–∞:</h4>
        <p><strong>–ü—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∞—è:</strong> ${face.dominant_race}</p>
        ${Object.entries(face.race).map(([race, value]) => `
            <div><strong>${race}</strong>: ${value}%</div>
        `).join('')}
    ` : '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å–µ</p>';

    details.innerHTML = `
        <h3>–ê–Ω–∞–ª–∏–∑ –ª–∏—Ü–∞ ‚Ññ${face.Id}</h3>
        <p><strong>–ü–æ–ª:</strong> ${face.dominant_gender}</p>
        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${face.age}</p>
        <p><strong>–ü—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∞—è —ç–º–æ—Ü–∏—è:</strong> ${face.dominant_emotion}</p>

        <div style="display: flex; gap: 30px;">
            <div>
                <h4>–≠–º–æ—Ü–∏–∏:</h4>
                ${emotionsHTML}
            </div>
            <div>
                ${raceHTML}
            </div>
        </div>
    `;

    modal.style.display = 'flex';

    modal.querySelector('.close-btn').onclick = () => {
        modal.style.display = 'none';
    };
}

  </script>


{% endblock %}

